# Statute Migration Script

## Overview

The `migrate-statutes.php` script migrates statute data from the old SQLite database (`old_database.sqlite`) to the new Laravel database structure (`database.sqlite`). It uses a pattern-based approach to handle different legal document structures while maintaining clean separation between old reference IDs and new auto-generated IDs.

## Key Features

- **Pattern-Based Migration**: Configurable patterns for different legal document structures
- **Clean ID Management**: Uses old IDs only as references, lets new database auto-generate clean IDs
- **Structure-Named Patterns**: Pattern names reflect actual hierarchy (e.g., `part-section-subsection`)
- **Automatic Slug Generation**: Omits slugs during migration, letting Laravel models generate them automatically
- **Transaction Safety**: Full rollback on errors with comprehensive error handling
- **Progress Tracking**: Detailed console output with verbose mode
- **Dry Run Support**: Preview migrations without making changes

## Usage

```bash
php migrate-statutes.php [options]
```

### Options

| Option | Description | Default |
|--------|-------------|---------|
| `--dry-run` | Preview migration without making changes | false |
| `--skip-backup` | Skip creating backup before migration | false |
| `--verbose` | Show detailed output including progress | false |
| `--pattern=NAME` | Migration pattern to use | `part-section-subsection` |
| `--statute-id=ID` | Migrate specific statute only (old database ID) | all statutes |
| `--batch-size=N` | Records per batch | 100 |

### Examples

```bash
# Dry run to preview migration
php migrate-statutes.php --dry-run

# Migrate all statutes with verbose output
php migrate-statutes.php --verbose

# Migrate specific statute only
php migrate-statutes.php --statute-id=49 --verbose

# Use different pattern (when available)
php migrate-statutes.php --pattern=chapter-section-subsection
```

## Migration Patterns

### `part-section-subsection` (Default)

**Structure**: Federal Act Pattern (Nigerian Acts like ACJA 2015)
```
Statute
├── Divisions (Parts) - Level 1
│   ├── Provisions (Sections) - Level 2  
│   │   └── Child Provisions (Subsections) - Level 3
```

**Database Mapping**:
- `statutes` → `statutes` table
- `statute_chapters` → `statute_divisions` table (division_type: 'part', level: 1)
- `statute_sections` → `statute_provisions` table (provision_type: 'section', level: 2)
- `sub_sections` → `statute_provisions` table (provision_type: 'subsection', level: 3)

**Field Mappings**:
```php
// Statutes
old.title → new.title
old.description → new.description  
old.country → new.country (default: 'Nigeria')

// Divisions (Parts)
old.chapter_title → new.division_title
old.chapter_number → new.division_number
old.chapter_content → new.content

// Provisions (Sections) 
old.section_title → new.provision_title
old.section_number → new.provision_number
old.section_text → new.provision_text

// Child Provisions (Subsections)
old.sub_section_number → new.provision_number
old.sub_section_text → new.provision_text
```

## Migration Process

### Phase 1: Migrate Statutes
- Extracts all statutes from old database
- Creates clean records in new `statutes` table
- Maps old statute IDs to new auto-generated IDs in memory

### Phase 2: Migrate Divisions
- Processes divisions (parts/chapters) from old database
- Creates records in `statute_divisions` table
- Links to new statute IDs using in-memory mapping
- Maps old division IDs to new IDs for next phase

### Phase 3: Migrate Provisions
- Processes main provisions (sections) from old database
- Creates records in `statute_provisions` table
- Links to statute and division using ID mappings
- Maps old section IDs to new provision IDs

### Phase 4: Migrate Child Provisions
- Processes child provisions (subsections) from old database
- Creates records in `statute_provisions` table with parent relationships
- Links via `parent_provision_id` using section ID mappings
- Maintains proper hierarchy levels

## ID Management Strategy

### Clean Separation Approach
- **Old IDs**: Used only as references during migration
- **New IDs**: Auto-generated by database, kept clean
- **In-Memory Mapping**: Tracks old_id → new_id relationships during script execution
- **No ID Pollution**: New database contains no traces of old ID structure

### Example ID Flow
```php
// Phase 1: Statute migration
old_statute_id: 49 → new_statute_id: 5 (auto-generated)
$idMaps['statutes'][49] = 5;

// Phase 2: Division migration  
old_chapter_id: 40 → new_division_id: 7 (auto-generated)
$idMaps['divisions'][40] = 7;
// Links to statute_id: 5 (from mapping)

// Phase 3: Provision migration
old_section_id: 64 → new_provision_id: 8 (auto-generated)  
$idMaps['provisions'][64] = 8;
// Links to statute_id: 5, division_id: 7

// Phase 4: Child provision migration
old_subsection_id: 120 → new_provision_id: 9 (auto-generated)
// Links to statute_id: 5, division_id: 7, parent_provision_id: 8
```

## Error Handling

### Transaction Safety
- All phases wrapped in database transaction
- Complete rollback on any error
- Database restored to original state on failure

### Error Tolerance
- Continues processing after individual record errors
- Stops migration if error count exceeds threshold (10 errors)
- Detailed error reporting with context

### Validation
- Verifies database connections and table existence
- Checks required fields and relationships
- Validates user permissions and default user existence

## Output and Logging

### Standard Output
```
=== STATUTE MIGRATION SCRIPT ===
Old DB: /path/to/old_database.sqlite
New DB: /path/to/database.sqlite
Pattern: part-section-subsection - Federal Act Pattern
Mode: LIVE MIGRATION

Connecting to databases...
Found 1 statutes to migrate
Found 3 divisions
Found 6 provisions  
Found 12 child provisions

Phase 1: Migrating statutes...
Phase 1 complete: 1 statutes migrated

Phase 2: Migrating divisions (part)...
Phase 2 complete: 3 divisions migrated

Phase 3: Migrating provisions (section)...
Phase 3 complete: 6 provisions migrated

Phase 4: Migrating child provisions (subsection)...
Phase 4 complete: 12 child provisions migrated

=== MIGRATION COMPLETE ===
Successfully migrated:
  Statutes: 1
  Divisions: 3
  Provisions: 6  
  Child Provisions: 12
```

### Verbose Output
With `--verbose` flag, shows detailed progress:
```
  ✓ Statute: ADMINISTRATION OF CRIMINAL JUSTICE ACT, 2015 (old ID: 49 → new ID: 5)
  ✓ Division: PRELIMINARY (old ID: 40 → new ID: 7)
  ✓ Provision: Purpose (old ID: 64 → new ID: 8)
  ✓ Child Provision: (1) (old ID: 120 → new ID: 9)
```

## Backup and Recovery

### Automatic Backup
- Creates timestamped backup before migration
- Backup location: `database/backups/backup_statutes_migration_YYYY-MM-DD_HH-MM-SS.sqlite`
- Can be skipped with `--skip-backup` flag

### Recovery
```bash
# If migration fails or needs to be reverted:
cp database/backups/backup_statutes_migration_2025-08-05_12-30-45.sqlite database/database.sqlite
```

## Post-Migration

### Slug Generation
Slugs are automatically generated when records are first accessed via Laravel Eloquent models. No manual action required.

### Verification
Script provides verification output showing:
- Final record counts in each table
- Sample records with relationship counts
- Data integrity confirmation

### Testing
After migration, test the Laravel API endpoints to ensure:
- Statute retrieval works correctly
- Hierarchical relationships are intact
- Slugs are generated properly on access

## Adding New Patterns

To add support for new legal document structures:

1. **Define Pattern Configuration**:
```php
$patterns['chapter-section-subsection'] = [
    'name' => 'Constitutional Pattern',
    'description' => 'Constitution-style documents',
    'divisions' => [
        'source_table' => 'constitution_chapters',
        'division_type' => 'chapter',
        'level' => 1,
        // ... field mappings
    ],
    // ... provisions and child_provisions config
];
```

2. **Update Field Mappings**: Adjust field names to match source database schema

3. **Test with Dry Run**: Always test new patterns with `--dry-run` first

## Troubleshooting

### Common Issues

**"Required table not found"**
- Verify old database has expected table structure
- Check table names in pattern configuration

**"Default user ID does not exist"**  
- Ensure user with ID 1 exists in new database
- Or update `$defaultUserId` in script

**"Too many errors encountered"**
- Review error messages for data quality issues
- Consider cleaning source data first
- Increase error threshold if needed

**"UNIQUE constraint failed"**
- Usually indicates duplicate data in old database
- Use `--statute-id` to migrate specific records
- Check for data conflicts

### Recovery Steps
1. Check backup was created successfully
2. Restore from backup if needed: `cp backup_file database/database.sqlite`
3. Review error messages and fix source data issues
4. Re-run migration with `--dry-run` to test
5. Run live migration again

## Performance Notes

- Migration processes records in batches (default: 100)
- Uses prepared statements for efficiency
- In-memory ID mapping for fast lookups
- Transaction batching for optimal performance
- Estimated time: ~1-2 minutes per 1000 records on standard hardware